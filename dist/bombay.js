!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Bombay=t()}(this,function(){"use strict";var d=function(){return(d=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},l={reportUrl:"http://localhost:10000",token:"",appVersion:"1.0.0",environment:"production",outtime:300,enableSPA:!0,autoSendPv:!0,isPage:!0,isAjax:!0,isResource:!0,isError:!0,isRecord:!0,isBehavior:!0,ignore:{ignoreErrors:[],ignoreUrls:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]},behavior:{console:["log","error"],click:!0},maxLength:1e3};function s(e){return e&&l[e]||{}}function n(){}function o(){for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");0<n--;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var a=0;a<8;a++)o.splice(3*a+2,0,r[a]);return o.join("")}function r(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&")}function u(e,t){var n=0,o=e.length;if(function(e,t){e=Object.prototype.toString.call(e).substring(8).replace("]","");return t?e===t:e}(e,"Array"))for(;n<o&&!1!==t.call(e[n],e[n],n);n++);else for(var r in e)if(!1===t.call(e[r],e[r],r))break;return e}function f(e,t){var n;window.CustomEvent?n=new CustomEvent(e,{detail:t}):((n=window.document.createEvent("HTMLEvents")).initEvent(e,!1,!0),n.detail=t),window.dispatchEvent(n)}function a(e){return 1<(e=e.split("::")).length?{group:e[0],key:e[1]}:{group:"default_group",key:e[0]}}var t=function(n,o,r){window.addEventListener?window.addEventListener(n,function e(t){r&&window.removeEventListener(n,e,!0),o.call(this,t)},!0):window.attachEvent&&window.attachEvent("on"+n,function e(t){r&&window.detachEvent("on"+n,e),o.call(this,t)})},i=function(e,t){return t&&(window.removeEventListener?window.removeEventListener(e,t):window.detachEvent&&window.detachEvent(e,t)),this},h=function(e){return(e?v(e.replace(/^#\/?/,"")):"")||"[index]"},v=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},w=function(){var e="object"==typeof console?console.warn:n;try{var t={warn:e};t.warn.call(t)}catch(e){return n}return e}(),c=function(e,o){return e.reduce(function(e,t,n){return o(t,n)?n:e},-1)},p=self!=top,g={page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0},circle:!1,cssInserted:!1};function y(e,t){"error"===e&&g._health.errcount++,"api"===e&&t&&g._health.apisucc++,"api"!==e||t||g._health.apifail++}function m(){var e,t,n=navigator.connection;return{t:"",page:g.page||location.pathname.toLowerCase(),times:1,v:l.appVersion,token:l.token,e:l.environment,begin:(new Date).getTime(),uid:function(){var e=localStorage.getItem("bombay_uid")||"";e||(e=o(),localStorage.setItem("bombay_uid",e));return e}(),sid:g.sid,sr:screen.width+"x"+screen.height,vp:(e=document.documentElement.clientWidth||document.body.clientWidth,t=document.documentElement.clientHeight||document.body.clientHeight,e+"x"+t),ct:n?n.effectiveType:"",ul:(navigator.language||navigator.userLanguage).substr(0,2),_v:"1.0.9",o:location.href}}function b(e){var t;return"res"!==e.t&&"error"!==e.t&&"behavior"!==e.t&&"health"===e.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?("object"==typeof(t=e)&&(t=r(t)),t=l.reportUrl+"?"+t,window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(t):w("[arms] navigator.sendBeacon not surported")):L(e),this}function L(e){var t,n=e[e.t];delete e[e.t],function(e,t){var n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var o=new n;o.open("POST",e,!0),o.setRequestHeader("Content-Type","text/plain"),o.send(JSON.stringify(t))}catch(e){w("[bombayjs] Failed to log, POST请求失败")}else w("[bombayjs] Failed to log, 浏览器不支持XMLHttpRequest")}(l.reportUrl+"?"+r(e),((t={})[e.t]=n,t))}var E="bombayjs-circle-active",S="bombayjs-circle-css";function _(e){if(!e||1!==e.nodeType)return"";var t=[],n=0,o="";t.push("("+e.innerText.substr(0,50)+")");for(var r=e||null;r&&n++<5&&"html"!==(o=function(e){var t,n,o,r,a=[];if(!e||!e.tagName)return"";if(a.push(e.tagName.toLowerCase()),e.id&&a.push("#".concat(e.id)),(t=e.className)&&"[object String]"===Object.prototype.toString.call(t))for(n=t.split(/\s+/),s=0;s<n.length;s++)n[s].indexOf("active")<0&&a.push(".".concat(n[s]));for(var i=["type","name","title","alt"],s=0;s<i.length;s++)(r=e.getAttribute(o=i[s]))&&a.push("[".concat(o,'="').concat(r,'"]'));return a.join("")}(r));)t.push(o),r=r.parentNode;return t.reverse().join(" > ")}function e(e){if(g.circle){var t=e.target.className.split(/\s+/),n=_(e.target),n=1===t.length||2===t.length&&""===t[0]?n.replace(/\.\.bombayjs-circle-active/,""):n.replace(/\.bombayjs-circle-active/,"");return window.parent.postMessage({t:"setElmPath",path:n,page:g.page},"*"),void e.stopPropagation()}var o;try{o=e.target}catch(e){o="<unknown>"}"INPUT"!==o.nodeName&&"TEXTAREA"!==o.nodeName&&(0===o.length||(e={type:"ui.click",data:{path:_(o),message:""}}).data.path&&(o=m(),b(d(d({},o),{t:"behavior",behavior:e}))))}function R(e){var t;try{t=e.target}catch(e){t="<unknown>"}"INPUT"!==t.nodeName&&"TEXTAREA"!==t.nodeName||0===t.length||(e={type:"ui.blur",data:{path:_(t),message:t.value}}).data.path&&e.data.message&&(t=m(),b(d(d({},t),{t:"behavior",behavior:e})))}var j=["","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","","domInteractive","","domContentLoadedEventEnd","","loadEventStart","","msFirstPaint","secureConnectionStart"];function C(e){var t=l.enableSPA?h(location.hash.toLowerCase()):location.pathname.toLowerCase();t&&x(t,!1)}function T(e){e=l.enableSPA?h(e.detail.toLowerCase()):e.detail.toLowerCase();e&&x(e,!1)}function x(e,t){var n;t||k(),n=e,t=m(),b(d(d({},t),{t:"behavior",behavior:{type:"navigation",data:{from:t.page,to:n}}})),p&&window.parent.postMessage({t:"setPage",href:location.href,page:e},"*"),e=e,g.page=e,g.sid=o(),g.sBegin=Date.now(),l.autoSendPv&&(e=m(),b(d(d({},e),{t:"pv",dt:document.title,dl:location.href,dr:document.referrer,dpr:window.devicePixelRatio,de:document.charset})))}function k(){var e=g._health.errcount?0:1,t=m(),e=d(d(d({},t),g._health),{t:"health",healthy:e,stay:Date.now()-g.sBegin});g._health={errcount:0,apisucc:0,apifail:0},b(e)}function A(e){switch(e.type){case"error":e instanceof ErrorEvent?(o=e,r=m(),a=o.name||"CustomError",i=o.message||"",s=o.error.stack||"",b(d(d({},r),{t:"error",st:"caughterror",cate:a,msg:i&&i.substring(0,1e3),detail:s&&s.substring(0,1e3),file:o.filename||"",line:o.lineno||"",col:o.colno||""}))):(t=e,n=m(),t=t.target,b(d(d({},n),{t:"error",st:"resource",msg:t.outerHTML,file:t.src,stack:t.localName.toUpperCase()})));break;case"unhandledrejection":n=e,t=m(),b(d(d({},t),{t:"error",st:"promise",msg:n.reason}))}var t,n,o,r,a,i,s;y("error")}function P(){var e=window.performance;if(!e||"object"!=typeof e||"function"!=typeof e.getEntriesByType)return null;var t,n=m(),o=d(d({},n),{dom:0,load:0,t:"res",res:[]}),r=e.timing||{},n=e.getEntriesByType("resource")||[];"function"!=typeof window.PerformanceNavigationTiming||(e=e.getEntriesByType("navigation")[0])&&(r=e),u({dom:[10,8],load:[14,1]},function(e,t){var n=r[j[e[1]]],e=r[j[e[0]]];void 0===n||void 0===e||0<=(n=Math.round(e-n))&&n<36e5&&(o[t]=n)}),n=n.filter(function(t){return!(-1<c(s("ignore").ignoreApis,function(e){return-1<t.name.indexOf(e)}))}),-1<navigator.userAgent.indexOf("Edge")&&(t=[],u(n,function(e){t.push({connectEnd:e.connectEnd,connectStart:e.connectStart,domainLookupEnd:e.connectStart,domainLookupStart:e.domainLookupStart,duration:e.duration,entryType:e.entryType,fetchStart:e.fetchStart,initiatorType:e.initiatorType,name:e.name,redirectEnd:e.redirectEnd,redirectStart:e.redirectStart,responseEnd:e.responseEnd,responseStart:e.responseStart,startTime:e.startTime})}),n=t),o.res=n,b(o)}function N(t,e,n,o,r,a){var i;t?(y("api",e),i=m(),r=d(d({},i),{t:"api",beigin:a,url:t,success:e,time:n,code:o,msg:r}),-1<c(s("ignore").ignoreApis,function(e){return-1<t.indexOf(e)})||b(r)):w("[retcode] api is null")}function B(e){var t=document.getElementsByClassName(E);if(0<t.length)for(var n=0;n<t.length;n++)t[n].className=t[n].className.replace(/ bombayjs-circle-active/g,"");e.target.className+=" "+E}function M(){!function(){var t="."+E+"{border: #ff0000 2px solid;}",n=document.createElement("style");n.type="text/css",n.id=S;try{n.appendChild(document.createTextNode(t))}catch(e){n.styleSheet.cssText=t}document.getElementsByTagName("head")[0].appendChild(n)}(),g.cssInserted=!0,g.circle=!0,t("mouseover",B)}function O(){var e;(e=document.getElementById(S)).parentNode.removeChild(e),g.cssInserted=!1,g.circle=!1,i("mouseover",B)}function H(e){e.data&&e.data.t&&("setCircle"===e.data.t?(Boolean(e.data.v)?M:O)():"back"===e.data.t?window.history.back():"forward"===e.data.t&&window.history.forward())}function I(){if(window&&window.console)for(var e=l.behavior.console,t=0;e.length;t++){var n=e[t],o=window.console[n];if(!window.console[n])return;!function(o,r){window.console[o]=function(){var e,t=Array.prototype.slice.apply(arguments),n={type:"console",data:{level:o,message:JSON.stringify(t)}};e=n,n=m(),b(d(d({},n),{t:"behavior",behavior:e})),r&&r.apply(null,t)}}(n,o)}}function U(u){var e,p=history[u];"function"==typeof p&&(history[u]=function(e,t,n){window.__bb_onpopstate_||(window.__bb_onpopstate_=window.onpopstate,window.onpopstate=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(x(l.enableSPA?h(location.hash.toLowerCase()):location.pathname.toLowerCase(),!1),window.__bb_onpopstate_)return window.__bb_onpopstate_.apply(this,t)});var o=1===arguments.length?[e]:Array.apply(null,arguments),e=location.href,o=p.apply(history,o);if(!n||"string"!=typeof n)return o;if(n===e)return o;try{var r=e.split("#"),a=n.split("#"),i=v(r[0]),s=v(a[0]),c=r[1]&&r[1].replace(/^\/?(.*)/,"$1"),d=a[1]&&a[1].replace(/^\/?(.*)/,"$1");i!==s?f("historystatechanged",s):c!==d&&f("historystatechanged",d)}catch(e){w("[retcode] error in "+u+": "+e)}return o},history[u].toString=(e=u,function(){return e+"() { [native code] }"}))}function D(){!function(){{var o;"function"==typeof window.fetch&&(o=window.fetch,window.__oFetch_=o,window.fetch=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments),r=Date.now(),e=(e&&"string"!=typeof e?e.url:e)||"",a=v(e);return a?o.apply(window,n).then(function(e){var t=e.clone(),n=t.headers;if(n&&"function"==typeof n.get){n=n.get("content-type");if(n&&!/(text)|(json)/.test(n))return e}var o=Date.now()-r;return t.text().then(function(e){t.ok?N(a,!0,o,status,e.substr(0,1e3)||"",r):N(a,!1,o,status,e.substr(0,1e3)||"",r)}),e}):o.apply(window,n)})}}(),function(){{var r,a,i;"function"==typeof window.XMLHttpRequest&&(r=0,a="",i=window.XMLHttpRequest,window.__oXMLHttpRequest_=i,window.XMLHttpRequest=function(e){var o=new i(e);if(!o.addEventListener)return o;var n=o.open,t=o.send;return o.open=function(e,t){e=1===arguments.length?[e]:Array.apply(null,arguments);a=v(t),n.apply(o,e)},o.send=function(){r=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.apply(o,e)},o.onreadystatechange=function(){if(a&&4===o.readyState){var e=Date.now()-r;if(200<=o.status&&o.status<=299){var t=o.status||200;if("function"==typeof o.getResponseHeader){var n=o.getResponseHeader("Content-Type");if(n&&!/(text)|(json)/.test(n))return}N(a,!0,e,t,o.responseText.substr(0,l.maxLength)||"",r)}else N(a,!1,e,t||"FAILED",o.responseText.substr(0,l.maxLength)||"",r)}},o})}}()}function q(e,t){this.init(e)}return q.prototype.init=function(e){!e||e.token?(e=e,x((l=d(d({},l),e)).enableSPA?h(location.hash.toLowerCase()):location.pathname.toLowerCase(),!0),l.isPage&&this.sendPerf(),l.enableSPA&&this.addListenRouterChange(),l.isError&&this.addListenJs(),l.isAjax&&this.addListenAjax(),l.isRecord&&this.addRrweb(),l.isBehavior&&this.addListenBehavior(),l.isResource&&this.sendResource(),(window.__bb=this).addListenUnload(),t("message",H),g.circle&&M()):console.warn("请输入一个token")},q.prototype.sendPerf=function(){var r,a,o,i,s,c;(c=window.performance)&&"object"==typeof c&&(r={dns:0,tcp:0,ssl:0,ttfb:0,trans:0,dom:0,res:0,firstbyte:0,fpt:0,tti:0,ready:0,load:0},a=c.timing||{},o=Date.now(),i=1,s=setInterval(function(){var e,t,n;a.loadEventEnd&&(clearInterval(s),"function"!=typeof window.PerformanceNavigationTiming||(e=c.getEntriesByType("navigation")[0])&&(a=e,i=2),u({dns:[3,2],tcp:[5,4],ssl:[5,17],ttfb:[7,6],trans:[8,7],dom:[10,8],res:[14,12],firstbyte:[7,2],fpt:[8,1],tti:[10,1],ready:[12,1],load:[14,1]},function(e,t){var n=a[j[e[1]]],o=a[j[e[0]]],e=Math.round(o-n);(2===i||void 0!==n&&void 0!==o)&&0<=(e="dom"===t?Math.round(o-n):e)&&e<36e5&&(r[t]=e)}),t=window.navigator.connection||window.navigator.mozConnection||window.navigator.webkitConnection,e=c.navigation||{type:void 0},r.ct=t?t.effectiveType||t.type:"",(t=999<(t=t&&(t.downlink||t.downlinkMax||t.bandwidth)||null)?999:t)&&(r.bandwidth=t),r.navtype=1===e.type?"Reload":"Other",1===i&&0<a[j[16]]&&0<a[j[1]]&&0<=(n=a[j[16]]-a[j[1]])&&n<36e5&&(r.fpt=n),1===i&&0<a[j[1]]?r.begin=a[j[1]]:2===i&&0<r.load?r.begin=o-r.load:r.begin=o,n=m(),b(d(d(d({},n),{t:"perf"}),r)))},50))},q.prototype.sendResource=function(){"complete"===window.document.readyState?P():this.addListenResource()},q.prototype.addListenResource=function(){t("load",P)},q.prototype.addListenBehavior=function(){I(),l.behavior.click&&this.addListenClick()},q.prototype.addListenClick=function(){t("click",e),t("blur",R)},q.prototype.addListenRouterChange=function(){U("pushState"),U("replaceState"),t("hashchange",C),t("historystatechanged",T)},q.prototype.addListenJs=function(){t("error",A),t("unhandledrejection",A)},q.prototype.addListenAjax=function(){D()},q.prototype.addListenUnload=function(){t("beforeunload",k),this.destroy()},q.prototype.addRrweb=function(){},q.prototype.removeListenRouterChange=function(){i("hashchange",C),i("historystatechanged",T)},q.prototype.removeListenJs=function(){i("error",A),i("unhandledrejection",A)},q.prototype.removeListenResource=function(){i("beforeunload",k)},q.prototype.removeListenAjax=function(){},q.prototype.removeListenUnload=function(){i("load",P)},q.prototype.removeRrweb=function(){},q.prototype.sum=function(e,t){!function(e,t){void 0===t&&(t=1);var n=m(),e=a(e);b(d(d(d({},n),e),{t:"sum",val:t}))}(e,t)},q.prototype.avg=function(e,t){!function(e,t){void 0===t&&(t=1);var n=m(),e=a(e);b(d(d(d({},n),e),{t:"avg",val:t}))}(e,t)},q.prototype.msg=function(e){var t;t=e,e=m(),t=a(t),b(d(d({},e),{t:"msg",group:t.group,msg:t.key.substr(0,l.maxLength)}))},q.prototype.api=function(e,t,n,o,r){N(e,t,n,o,r,Date.now())},q.prototype.destroy=function(){l.enableSPA&&this.removeListenRouterChange(),l.isError&&this.removeListenJs(),l.isAjax&&this.removeListenAjax(),l.isRecord&&this.removeRrweb(),l.isResource&&this.removeListenResource(),this.removeListenResource()},q});
