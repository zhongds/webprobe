!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Webprode=t()}(this,function(){"use strict";var d=function(){return(d=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},l={reportUrl:"http://localhost:10000",token:"",appVersion:"1.0.0",environment:"production",outtime:300,enableSPA:!0,autoSendPv:!0,autoSendUv:!0,isPage:!0,isAjax:!0,isResource:!0,isError:!0,isRecord:!0,isBehavior:!0,ignore:{ignoreErrors:[],ignoreUrls:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]},behavior:{console:["log","error"],click:!0},maxLength:1e3};function s(e){return e&&l[e]||{}}function n(){}function o(){for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");0<n--;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var a=0;a<8;a++)o.splice(3*a+2,0,r[a]);return o.join("")}function u(e,t){var n=0,o=e.length;if(function(e,t){e=Object.prototype.toString.call(e).substring(8).replace("]","");return t?e===t:e}(e,"Array"))for(;n<o&&!1!==t.call(e[n],e[n],n);n++);else for(var r in e)if(!1===t.call(e[r],e[r],r))break;return e}function f(e,t){var n;window.CustomEvent?n=new CustomEvent(e,{detail:t}):((n=window.document.createEvent("HTMLEvents")).initEvent(e,!1,!0),n.detail=t),window.dispatchEvent(n)}function r(e){return 1<(e=e.split("::")).length?{group:e[0],key:e[1]}:{group:"default_group",key:e[0]}}var t=function(n,o,r){window.addEventListener?window.addEventListener(n,function e(t){r&&window.removeEventListener(n,e,!0),o.call(this,t)},!0):window.attachEvent&&window.attachEvent("on"+n,function e(t){r&&window.detachEvent("on"+n,e),o.call(this,t)})},a=function(e,t){return t&&(window.removeEventListener?window.removeEventListener(e,t):window.detachEvent&&window.detachEvent(e,t)),this},h=function(e){return(e?v(e.replace(/^#\/?/,"")):"")||"[index]"},v=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},g=function(){var e="object"==typeof console?console.warn:n;try{var t={warn:e};t.warn.call(t)}catch(e){return n}return e}(),c=function(e,o){return e.reduce(function(e,t,n){return o(t,n)?n:e},-1)},i=self!=top,p={page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0},circle:!1,cssInserted:!1,cacheReports:[]};function w(e,t){"error"===e&&p._health.errcount++,"api"===e&&t&&p._health.apisucc++,"api"!==e||t||p._health.apifail++}function y(){var e,t,n=navigator.connection;return{t:"",page:p.page||location.pathname.toLowerCase(),times:1,v:l.appVersion,token:l.token,e:l.environment,begin:(new Date).getTime(),uid:function(){var e=localStorage.getItem("webprode_uid")||"";e||(e=o(),localStorage.setItem("webprode_uid",e));return e}(),sid:p.sid,sr:screen.width+"x"+screen.height,vp:(e=document.documentElement.clientWidth||document.body.clientWidth,t=document.documentElement.clientHeight||document.body.clientHeight,e+"x"+t),ct:n?n.effectiveType:"",ul:(navigator.language||navigator.userLanguage).substr(0,2),pkv:"1.0.9",o:location.href}}function m(e){var t;"res"!==e.t&&"error"!==e.t&&"behavior"!==e.t&&"health"===e.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?(t=e,window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(l.reportUrl,JSON.stringify(t)):g("[arms] navigator.sendBeacon not surported")):b(e)}function b(e){p.cacheReports.push(e),"complete"===window.document.readyState&&setTimeout(function(){0<p.cacheReports.length&&(function(e,t){var n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var o=new n;o.open("POST",e,!0),o.setRequestHeader("Content-Type","text/plain"),o.send(JSON.stringify(t))}catch(e){g("[webprode] Failed to log, POST请求失败")}else g("[webprode] Failed to log, 浏览器不支持XMLHttpRequest")}(l.reportUrl,p.cacheReports),p.cacheReports=[])},500)}var L="webprode-circle-active",E="webprode-circle-css";function e(){var e;l.autoSendUv&&(!function(){var e=localStorage.getItem("webprode_uv_tag")||"";try{if(e&&(new Date).toDateString()===new Date(+e).toDateString())return}catch(e){}return console.log("vvvv","测试uv"),localStorage.setItem("webprode_uv_tag",Date.now().toString()),1}()||(e=y(),m(d(d({},e),{t:"uv",ip:""}))))}function S(e){if(!e||1!==e.nodeType)return"";var t=[],n=0,o="";t.push("("+e.innerText.substr(0,50)+")");for(var r=e||null;r&&n++<5&&"html"!==(o=function(e){var t,n,o,r,a=[];if(!e||!e.tagName)return"";if(a.push(e.tagName.toLowerCase()),e.id&&a.push("#".concat(e.id)),(t=e.className)&&"[object String]"===Object.prototype.toString.call(t))for(n=t.split(/\s+/),s=0;s<n.length;s++)n[s].indexOf("active")<0&&a.push(".".concat(n[s]));for(var i=["type","name","title","alt"],s=0;s<i.length;s++)(r=e.getAttribute(o=i[s]))&&a.push("[".concat(o,'="').concat(r,'"]'));return a.join("")}(r));)t.push(o),r=r.parentNode;return t.reverse().join(" > ")}function _(e){if(p.circle){var t=e.target.className.split(/\s+/),n=S(e.target),n=1===t.length||2===t.length&&""===t[0]?n.replace(/\.\.webprode-circle-active/,""):n.replace(/\.webprode-circle-active/,"");return window.parent.postMessage({t:"setElmPath",path:n,page:p.page},"*"),void e.stopPropagation()}var o;try{o=e.target}catch(e){o="<unknown>"}"INPUT"!==o.nodeName&&"TEXTAREA"!==o.nodeName&&(0===o.length||(e={type:"ui.click",data:{path:S(o),message:""}}).data.path&&(o=y(),m(d(d({},o),{t:"behavior",behavior:e}))))}function R(e){var t;try{t=e.target}catch(e){t="<unknown>"}"INPUT"!==t.nodeName&&"TEXTAREA"!==t.nodeName||0===t.length||(e={type:"ui.blur",data:{path:S(t),message:t.value}}).data.path&&e.data.message&&(t=y(),m(d(d({},t),{t:"behavior",behavior:e})))}var T=["","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","","domInteractive","","domContentLoadedEventEnd","","loadEventStart","","msFirstPaint","secureConnectionStart"];function k(e){var t=l.enableSPA?h(location.hash.toLowerCase()):location.pathname.toLowerCase();t&&C(t,!1)}function x(e){e=l.enableSPA?h(e.detail.toLowerCase()):e.detail.toLowerCase();e&&C(e,!1)}function C(e,t){var n;t||A(),n=e,t=y(),m(d(d({},t),{t:"behavior",behavior:{type:"navigation",data:{from:t.page,to:n}}})),i&&window.parent.postMessage({t:"setPage",href:location.href,page:e},"*"),e=e,p.page=e,p.sid=o(),p.sBegin=Date.now(),l.autoSendPv&&(e=y(),m(d(d({},e),{t:"pv",dt:document.title,dl:location.href,dr:document.referrer,dpr:window.devicePixelRatio,de:document.charset})))}function A(){var e=p._health.errcount?0:1,t=y(),e=d(d(d({},t),p._health),{t:"health",healthy:e,stay:Date.now()-p.sBegin});p._health={errcount:0,apisucc:0,apifail:0},m(e)}function j(e){switch(e.type){case"error":e instanceof ErrorEvent?(o=e,r=y(),a=o.name||"CustomError",i=o.message||"",s=o.error.stack||"",o=d(d({},r),{t:"error",st:"caughterror",cate:a,msg:i&&i.substring(0,1e3),detail:s&&s.substring(0,1e3),file:o.filename||"",line:o.lineno||"",col:o.colno||""}),console.log("错误信息",o),m(o)):(t=e,n=y(),t=t.target,m(d(d({},n),{t:"error",st:"resource",msg:t.outerHTML,file:t.src,stack:t.localName.toUpperCase()})));break;case"unhandledrejection":n=e,t=y(),m(d(d({},t),{t:"error",st:"promise",msg:n.reason}))}var t,n,o,r,a,i,s;w("error")}function P(){var e=window.performance;if(!e||"object"!=typeof e||"function"!=typeof e.getEntriesByType)return null;var t,n=y(),o=d(d({},n),{dom:0,load:0,t:"res",res:[]}),r=e.timing||{},n=e.getEntriesByType("resource")||[];"function"!=typeof window.PerformanceNavigationTiming||(e=e.getEntriesByType("navigation")[0])&&(r=e),u({dom:[10,8],load:[14,1]},function(e,t){var n=r[T[e[1]]],e=r[T[e[0]]];void 0===n||void 0===e||0<=(n=Math.round(e-n))&&n<36e5&&(o[t]=n)}),n=n.filter(function(t){return!(-1<c(s("ignore").ignoreApis,function(e){return-1<t.name.indexOf(e)}))}),-1<navigator.userAgent.indexOf("Edge")&&(t=[],u(n,function(e){t.push({connectEnd:e.connectEnd,connectStart:e.connectStart,domainLookupEnd:e.connectStart,domainLookupStart:e.domainLookupStart,duration:e.duration,entryType:e.entryType,fetchStart:e.fetchStart,initiatorType:e.initiatorType,name:e.name,redirectEnd:e.redirectEnd,redirectStart:e.redirectStart,responseEnd:e.responseEnd,responseStart:e.responseStart,startTime:e.startTime})}),n=t),o.res=n,m(o)}function N(t,e,n,o,r,a){var i;t?(w("api",e),i=y(),r=d(d({},i),{t:"api",beigin:a,url:t,success:e,time:n,code:o,msg:r}),-1<c(s("ignore").ignoreApis,function(e){return-1<t.indexOf(e)})||m(r)):g("[retcode] api is null")}function B(e){var t=document.getElementsByClassName(L);if(0<t.length)for(var n=0;n<t.length;n++)t[n].className=t[n].className.replace(/ webprode-circle-active/g,"");e.target.className+=" "+L}function D(){!function(){var t="."+L+"{border: #ff0000 2px solid;}",n=document.createElement("style");n.type="text/css",n.id=E;try{n.appendChild(document.createTextNode(t))}catch(e){n.styleSheet.cssText=t}document.getElementsByTagName("head")[0].appendChild(n)}(),p.cssInserted=!0,p.circle=!0,t("mouseover",B)}function M(){var e;(e=document.getElementById(E)).parentNode.removeChild(e),p.cssInserted=!1,p.circle=!1,a("mouseover",B)}function U(e){e.data&&e.data.t&&("setCircle"===e.data.t?(Boolean(e.data.v)?D:M)():"back"===e.data.t?window.history.back():"forward"===e.data.t&&window.history.forward())}function H(u){var e,p=history[u];"function"==typeof p&&(history[u]=function(e,t,n){window.__bb_onpopstate_||(window.__bb_onpopstate_=window.onpopstate,window.onpopstate=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(C(l.enableSPA?h(location.hash.toLowerCase()):location.pathname.toLowerCase(),!1),window.__bb_onpopstate_)return window.__bb_onpopstate_.apply(this,t)});var o=1===arguments.length?[e]:Array.apply(null,arguments),e=location.href,o=p.apply(history,o);if(!n||"string"!=typeof n)return o;if(n===e)return o;try{var r=e.split("#"),a=n.split("#"),i=v(r[0]),s=v(a[0]),c=r[1]&&r[1].replace(/^\/?(.*)/,"$1"),d=a[1]&&a[1].replace(/^\/?(.*)/,"$1");i!==s?f("historystatechanged",s):c!==d&&f("historystatechanged",d)}catch(e){g("[retcode] error in "+u+": "+e)}return o},history[u].toString=(e=u,function(){return e+"() { [native code] }"}))}function I(){!function(){{var o;"function"==typeof window.fetch&&(o=window.fetch,window.__oFetch_=o,window.fetch=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments),r=Date.now(),e=(e&&"string"!=typeof e?e.url:e)||"",a=v(e);return a?o.apply(window,n).then(function(e){var t=e.clone(),n=t.headers;if(n&&"function"==typeof n.get){n=n.get("content-type");if(n&&!/(text)|(json)/.test(n))return e}var o=Date.now()-r;return t.text().then(function(e){t.ok?N(a,!0,o,status,e.substr(0,1e3)||"",r):N(a,!1,o,status,e.substr(0,1e3)||"",r)}),e}):o.apply(window,n)})}}(),function(){{var r,a,i;"function"==typeof window.XMLHttpRequest&&(r=0,a="",i=window.XMLHttpRequest,window.__oXMLHttpRequest_=i,window.XMLHttpRequest=function(e){var o=new i(e);if(!o.addEventListener)return o;var n=o.open,t=o.send;return o.open=function(e,t){e=1===arguments.length?[e]:Array.apply(null,arguments);a=v(t),n.apply(o,e)},o.send=function(){r=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.apply(o,e)},o.onreadystatechange=function(){if(a&&4===o.readyState){var e=Date.now()-r;if(200<=o.status&&o.status<=299){var t=o.status||200;if("function"==typeof o.getResponseHeader){var n=o.getResponseHeader("Content-Type");if(n&&!/(text)|(json)/.test(n))return}N(a,!0,e,t,o.responseText.substr(0,l.maxLength)||"",r)}else N(a,!1,e,t||"FAILED",o.responseText.substr(0,l.maxLength)||"",r)}},o})}}()}function O(e,t){this.init(e)}return O.prototype.init=function(e){!e||e.token?(console.log("init~~~~"),e=e,C((l=d(d({},l),e)).enableSPA?h(location.hash.toLowerCase()):location.pathname.toLowerCase(),!0),l.autoSendUv&&this.sendUv(),l.isPage&&this.sendPerf(),l.enableSPA&&this.addListenRouterChange(),l.isError&&this.addListenJs(),l.isAjax&&this.addListenAjax(),l.isRecord&&this.addRrweb(),l.isBehavior&&this.addListenBehavior(),l.isResource&&this.sendResource(),(window.__bb=this).addListenUnload(),t("message",U),p.circle&&D()):console.warn("请输入一个token")},O.prototype.sendPerf=function(){var r,a,o,i,s,c;(c=window.performance)&&"object"==typeof c&&(r={dns:0,tcp:0,ssl:0,ttfb:0,trans:0,dom:0,res:0,firstbyte:0,fpt:0,tti:0,ready:0,load:0},a=c.timing||{},o=Date.now(),i=1,s=setInterval(function(){var e,t,n;a.loadEventEnd&&(clearInterval(s),"function"!=typeof window.PerformanceNavigationTiming||(e=c.getEntriesByType("navigation")[0])&&(a=e,i=2),u({dns:[3,2],tcp:[5,4],ssl:[5,17],ttfb:[7,6],trans:[8,7],dom:[10,8],res:[14,12],firstbyte:[7,2],fpt:[8,1],tti:[10,1],ready:[12,1],load:[14,1]},function(e,t){var n=a[T[e[1]]],o=a[T[e[0]]],e=Math.round(o-n);(2===i||void 0!==n&&void 0!==o)&&0<=(e="dom"===t?Math.round(o-n):e)&&e<36e5&&(r[t]=e)}),t=window.navigator.connection||window.navigator.mozConnection||window.navigator.webkitConnection,e=c.navigation||{type:void 0},r.ct=t?t.effectiveType||t.type:"",(t=999<(t=t&&(t.downlink||t.downlinkMax||t.bandwidth)||null)?999:t)&&(r.bandwidth=t),r.navtype=1===e.type?"Reload":"Other",1===i&&0<a[T[16]]&&0<a[T[1]]&&0<=(n=a[T[16]]-a[T[1]])&&n<36e5&&(r.fpt=n),1===i&&0<a[T[1]]?r.begin=a[T[1]]:2===i&&0<r.load?r.begin=o-r.load:r.begin=o,n=y(),m(d(d(d({},n),{t:"perf"}),r)))},50))},O.prototype.sendUv=function(){e()},O.prototype.sendResource=function(){"complete"===window.document.readyState?P():this.addListenResource()},O.prototype.addListenResource=function(){t("load",P)},O.prototype.addListenBehavior=function(){l.behavior.click&&this.addListenClick()},O.prototype.addListenClick=function(){t("click",_),t("blur",R)},O.prototype.addListenRouterChange=function(){H("pushState"),H("replaceState"),t("hashchange",k),t("historystatechanged",x)},O.prototype.addListenJs=function(){t("error",j),t("unhandledrejection",j)},O.prototype.addListenAjax=function(){I()},O.prototype.addListenUnload=function(){t("beforeunload",A),this.destroy()},O.prototype.addRrweb=function(){},O.prototype.removeListenRouterChange=function(){a("hashchange",k),a("historystatechanged",x)},O.prototype.removeListenJs=function(){a("error",j),a("unhandledrejection",j)},O.prototype.removeListenResource=function(){a("beforeunload",A)},O.prototype.removeListenAjax=function(){},O.prototype.removeListenUnload=function(){a("load",P)},O.prototype.removeRrweb=function(){},O.prototype.sum=function(e,t){!function(e,t){void 0===t&&(t=1);var n=y(),e=r(e);m(d(d(d({},n),e),{t:"sum",val:t}))}(e,t)},O.prototype.avg=function(e,t){!function(e,t){void 0===t&&(t=1);var n=y(),e=r(e);m(d(d(d({},n),e),{t:"avg",val:t}))}(e,t)},O.prototype.msg=function(e){var t;t=e,e=y(),t=r(t),m(d(d({},e),{t:"msg",group:t.group,msg:t.key.substr(0,l.maxLength)}))},O.prototype.api=function(e,t,n,o,r){N(e,t,n,o,r,Date.now())},O.prototype.destroy=function(){l.enableSPA&&this.removeListenRouterChange(),l.isError&&this.removeListenJs(),l.isAjax&&this.removeListenAjax(),l.isRecord&&this.removeRrweb(),l.isResource&&this.removeListenResource(),this.removeListenResource()},O});
